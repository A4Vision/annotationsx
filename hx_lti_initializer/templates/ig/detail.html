{% load staticfiles %}
{% load list_of_ids %}
<!DOCTYPE html>
<html>
<head>
<script src="{% static "vendors/mirador/mirador.js" %}"></script>
{# Load the tag library #}
{% load bootstrap3 %}

{# Load CSS and JavaScript #}
{% bootstrap_css %}
{% bootstrap_javascript %}

{# Display django.contrib.messages as Bootstrap alerts #}
{% bootstrap_messages %}
<link rel="stylesheet" href="{% static "vendors/mirador/css/mirador-combined.css" %}">
<style type="text/css">
    #viewer { height:100%; height: calc(100% - 50px); height: -webkit-calc(100% - 50px); height:-moz-calc(100% - 50px);}
</style>
  <script src="{% static "vendors/development/underscore.js" %}"></script>
  <script src="{% static "vendors/development/jquery.timeago.js" %}"></script>
  <script src="{% static "vendors/development/jstz.js" %}"></script>
  <script src="{% static "vendors/development/jquery.unveil.js" %}"></script>
<script src="{% static "vendors/development/bootstrap-confirmation.js" %}"></script>
<script src="{% static "AController.js" %}"></script>
<script src="{% static "AnnotationMain.js" %}"></script>
<script src="{% static "AnnotationStoreController.js" %}"></script>
<script src="{% static "DashboardController.js" %}"></script>
<script src="{% static "DashboardView.js" %}"></script>
<script src="{% static "TargetObjectController.js" %}"></script>
<script src="{% static "vendors/development/jquery.tokeninput.js" %}"></script>
<link rel="stylesheet" href="{% static "vendors/development/css/summernote.css" %}">
<link rel="stylesheet" href="{% static "vendors/development/css/font-awesome.css" %}">
<link rel="stylesheet" href="{% static "vendors/Annotator/plugins/summernote-richtext-annotator.css" %}">
<link rel="stylesheet" href="{% static "css/dashboard.css" %}">
<link rel="stylesheet" href="{% static "vendors/development/css/mirador-token-input.css" %}">
  </head>
  <body>
  <div role="navigation" id="navigationBar" style="height:50px; background:black; top:0; display:block; position:absolute; width: 100%;">
    {% if is_instructor or org == "ATG" %}
      <a href="{% url 'hx_lti_initializer:course_admin_hub' %}" style="float:left; font-size: 2.5em; color: white; cursor:pointer;margin-top:7px; margin-left: 15px;"><i class="fa fa-home"></i></a>
      {% endif %}
    <div class="pagintation" style="width:300px;overflow:auto">

      {% if prev_object %}
      <a href="{% url 'hx_lti_initializer:access_annotation_target' course_id=course assignment_id=collection object_id=prev_object.target_object.id %}" style="float:left;margin:8px;position:relative;margin-left:20px;opacity:0.9;transition-duration:0.4s" class="btn btn-default" role="button" id="prev_target_object"><i class="glyphicon glyphicon-chevron-left"></i> Previous</a>
      {% endif %}
        {% if prev_object or next_object %}
        <div class="pages" style="float:left;font-size: 2em;color: white; font-family: Arial; margin-top:10px;margin-left:10px;margin-right:10px">{{assignment_target.order}} / {{ assignment.assignment_objects.count }}</div>
        {% endif %}
      {% if next_object %}
      <a href="{% url 'hx_lti_initializer:access_annotation_target' course_id=course assignment_id=collection object_id=next_object.target_object.id %}" style="float:left;margin:8px;position:relative;opacity:0.9;transition-duration:0.4s;" class="btn btn-default" role="button" id="next_target_object">Next <i class="glyphicon glyphicon-chevron-right"></i></a><br />
      {% endif %}
  </div>
    <div style="margin-right: 50px; float:right; margin-top:-45px;font-size:20pt; color:white; cursor:pointer;" role="button" tabindex="0" aria-label="Make annotations using keyboard input" alt="Make annotations using keyboard input" id="keyboard-input-button"><i class="fa fa-keyboard-o"></i></div>
     <div class="annotation-fullscreen" role="button" aria-label="Toggle Fullscreen Mode" style="color: white; float: right; margin-right: 17px; margin-top: -42px; font-size: 16pt; cursor:pointer;">
            <i class="fa fa-expand"></i>
        </div>
        {% if org == "HARVARDX" %}
        <div class="logo" aria-label="HarvardX Logo" style="margin-top:-45px; height:50px; margin-left: auto; margin-right:auto; position:relative;width:100px;"><img src="{% static "css/images/hx_inv.png" %}" style="height:40px;" /></div>
        {% endif %}
  </div>
  <div class="main" role="main" style="position:absolute;top:50px;height:100%;">
<div id="viewer" class="test">
</div>
<div id="dashboard"></div>
</div>
<script>
$(function() {
      var mir = Mirador({
        "id": "viewer",
        "mainMenuSettings" : {
           'show' : false
        },
        "buildPath" : "{% static "vendors/mirador/" %}",
        "layout" : "1x1",
        "saveSession" : false,
        "data": [
        {% for i in target_object.get_target_content_as_list %}
        { "manifestUri": "{{ i }}", "location": "Harvard University"},
        {% endfor %}
        ],
        "windowObjects": [
          {
            "loadedManifest": "{{ target_object.get_target_content_as_list.0 }}",
        	  "viewType" : "{{ viewType }}",
            {% if canvas_id %}
              "canvasID" : "{{ canvas_id }}",
            {% endif %}
            "annotationLayer" : true,
            "annotationCreation" : true,
        	  "sidePanel" : false,
            "fullScreen" : false,
            "displayLayout": false,
            "annotationState": "annoOnCreateOff",
            // This will eventually be put back in whenever we add layout options
            // to the admin hub
            // "layoutOptions" : 
            //  {
            //  "newObject" : true,
            //  "close" : false,
            //  "slotRight" : false,
            //  "slotLeft" : false,
            //  "slotAbove" : false,
            //  "slotBelow" : false
            //  }
          },
        ],
        "annotationEndpoint": 
          {
          "name":"Harvard CATCH Production",
          "module": "CatchEndpoint",
          "options": {
            token: "{{ token }}",
            // The endpoint of the store on your server.
            prefix: "/lti_init/annotation_api",
            userid : "{{ user_id }}",
            username : "{{ username }}",
            roles : "{{ roles }}",
            collection_id : "{{ collection }}",
            context_id : "{{ course }}",
          }
        }
      });
      
      var options = {
          commonInfo: {
          mediaType: "image", // {{ media_type }}
          context_id: "{{ course }}",
          collection_id: "{{ collection }}",
          object_id: {{ object }},
          token: "{{ token }}",
          username: "{{ username }}",
          user_id: "{{ user_id }}",
          is_instructor: "{{ is_instructor }}",
          pagination: {{ assignment.pagination_limit }},
        },
        
        annotationMainOptions: {
          {% if assignment.allow_highlights %}
          'highlightTags_options': "{{ assignment.highlights_options }}",
          {% endif %}
        },
        
        dashboardControllerOptions: {
          annotationElement: jQuery("#dashboard"),
          initOptions: {
            template_urls: '{% static "templates/dashboard/"%}',
            showPublicPrivateSelectors: true,
            showMediaSelector: false,
            flags: false,
            imageRootUrl: "{% static "vendors/catch/img"%}",
            instructors: {{ assignment.course.course_admins| list_of_ids | safe}},
            default_tab: "{{ assignment.default_tab }}",
            instructions: "{{instructions | escapejs }}",
            {% if focus_on_id %}
            focus_on_annotation: {{focus_on_id}},
            {% endif %}
          },
        },

        targetObjectOptions: {
        },
      };
      AController(options);
    });
  
</script>
<br />
<script>
  var toggleqtip = function(){
    jQuery('#keyboard-input-button').qtip({
        id: 'key-control-annotation',
        content: {
            text: "In order to use keyboard inputs, you must click on the image once. Then you can use the 'W', 'A', 'S', and 'D' keys to move up, left, down, and right respectively. You can also use '-' to zoom out, '=' to zoom in, and 'm' to make an annotation.",
            // Use first steps content...
            title: {
                text: "Control via keyboard",
                button: false
            }
        },
        position: {
            my: 'top center',
            at: 'bottom center',
            target: jQuery('#keyboard-input-button'),
            // Also use first steps position target...
            viewport: $(window) // ...and make sure it stays on-screen if possible
        },
        show: {
            event: false,
            // Only show when show() is called manually
            ready: true // Also show on page load
        },
        events: {
            render: function(event, api) {
                // Grab tooltip element
                var tooltip = api.elements.tooltip;
            }
        }
    });
};
  jQuery('#keyboard-input-button').on('mouseup', function (event){
    jQuery('.keyboard-command-area').attr('aria-label', 'Click this button to turn on keyboard input. To use keyboard input, select this area. Then use "W", "A", "S", "D" to move around. "-" to zoom out, "=" to zoom in" and lowercase "m" to make an annotation.');
    jQuery('.openseadragon-canvas').attr('tabindex', '-1');
    
    document.getElementById('viewer').querySelector('.openseadragon-canvas').focus();
    jQuery('.keyboard-command-area')[0].focus();
    jQuery('#keyboard-input-button').css('color', '#ffff00');
  });
  jQuery('#keyboard-input-button').on('mouseenter', function(){
    toggleqtip();
  });
  jQuery('#keyboard-input-button').on('keydown', function(event){
    var keyCode = event.keyCode;
    event = event || window.event;

    switch(keyCode) {
        case 32:
        case 13:
          toggleqtip();
          jQuery('#keyboard-input-button').css('color', '#ffff00');
          break;
    }
  });
  jQuery('#keyboard-input-button').on('blur', function(event){
    if (event.tooltip !== undefined) {
      jQuery('#keyboard-input-button').qtip().toggle(false);
    };
  });
  jQuery('#keyboard-input-button').on('mouseleave', function(event){
    jQuery('#keyboard-input-button').qtip().toggle(false);
  });

  jQuery('#viewer').off('keyup');
  jQuery('#viewer').on('keyup', function(event) {
    var keyCode = event.keyCode;
    // if you haven't already:
    event = event || window.event;

    switch(keyCode) {
      // 'a' key
      case 77:
        AController.dashboardObjectController.annotationViaKeyboardInput();
        jQuery('.newreplygroup #delete').click(function (e) {
          jQuery('.annotationModal #closeModal').click();
        });
        jQuery('.newreplygroup #save').click(function (e) {
          var tags = jQuery('.replyItemEdit #id_tags').val().split(' ');
          if (tags == ['']) {
            tags = [];
          };

          var miraWindow = AController.dashboardObjectController.endpoint.window;
          var miraEndpoint = AController.dashboardObjectController.endpoint.endpoint;
          var bounds = AController.dashboardObjectController.endpoint.currentImageBounds;
          var thumb = Mirador.Iiif.getImageUrl(miraWindow.imagesList[Mirador.getImageIndexById(miraWindow.imagesList, miraWindow.currentCanvasID)]);
          thumb = thumb + "/" + bounds.x + "," + bounds.y + "," + bounds.width + "," + bounds.height + "/full/0/native.jpg";
          var annotation = {
            collectionId: miraEndpoint.collection_id,
            contextId: miraEndpoint.context_id,
            uri: miraWindow.currentCanvasID,
            permissions: miraEndpoint.catchOptions.permissions,
            user: miraEndpoint.catchOptions.user,
            archived: false,
            rangePosition: bounds,
            bounds: bounds,
            thumb: thumb,
            ranges: [],
            tags: tags,
            text: jQuery('.replyItemEdit .replytext').val(),
            parent: "0",
            media: "image",
          };

          AController.dashboardObjectController.endpoint.endpoint.createCatchAnnotation(annotation);
          jQuery('.annotationModal #closeModal').click();
        });
        break;
    }
  });
var toggleFullscreen = function () {
        var self = this;
        var enterFullscreen = function() {
          var el = document.documentElement;
          if (el.requestFullscreen) {
            el.requestFullscreen();
          } else if (el.mozRequestFullScreen) {
            el.mozRequestFullScreen();
          } else if (el.webkitRequestFullscreen) {
            el.webkitRequestFullscreen();
          } else if (el.msRequestFullscreen) {
            el.msRequestFullscreen();
          }
        };

        var exitFullscreen = function() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
            
        };

        var isFullscreen = function() {
          var $fullscreen = $(fullscreenElement());
          return ($fullscreen.length > 0);
        };

        var fullscreenElement = function() {
          return (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement);
        };

        fullscreenElement() ? exitFullscreen() : enterFullscreen();
    };
  jQuery('.annotation-fullscreen').click(toggleFullscreen);
</script>
</body>
</html>
